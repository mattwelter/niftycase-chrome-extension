const activityFeed = {
  'CryptoCobain':'0x2eb5e5713a874786af6da95f6e4deacedb5dc246',
  'dan_OpenSea':'0x530cf036ed4fa58f7301a9c788c9806624cefd19', 
  'natechastain':'0xa3a4548b39da96eb065ff91811ca30da40431c0d',
  'OGDfarmer':'0xea39c551834d07ee2ee87f1ceff843c308e089af', 
  'OnlyToasted':'0x704c978d50590b21e4c2f43eb4da24fe61fcd707', 
  'pranksy':'0xd387a6e4e84a6c86bd90c158c6028a58cc8ac459', 
  'punk4156':'0xf476cd75be8fdd197ae0b466a2ec2ae44da41897', 
  'punk6529':'0xfd22004806a6846ea67ad883356be810f0428793', 
  'Anson_LauHK':'0xa20416801aC2eACf2372e825B4a90ef52490c2Bb', 
  'xaix2k':'0x2536c09E5F5691498805884fa37811Be3b2BDdb4',
  'y_kymin':'0xf305F90B19CF66fC2D038f92a26440B66cF858F6',
  'daria_daria14':'0x794A816f75f538D5a10437da10422E594966Bb9D', 
  'JasperMinds':'0xef32c2c04E4981Fd285A470790f2a4bCc7FC681d', 
  'nft_phoenix':'0xD1B8B7F4273DeAE46A6b2F3476182C365003AE30', 
  'ToppinOlivier':'0xD42932D00881B7fD07Ceca94c09b7A5B44f27355', 
  'RonensArt':'0xFDd02b8C8BA41C13c5cFb1915c880A8dDF4b8D0D', 
  'DaveOcampoart':'0x5716AeeC02F20a46275A9BD635f35673E5AE4f50',
  'raphael_riddle':'0x2100d73a21e62631c62599e5c6c0d2ace577c257',
  'HunchoPacko':'0xe136b2d9f1371cbca11b9c40699e47852de27746',
  'MathewAurelia':'0x432d635f551328f0517eed282748ad89407b684a',
  'lemonborja':'0x2f7b9f2f5f00dd2293b159b6e580a01e8da7acb1',
  'CryptoVonDoom':'0x591f8a2decc1c86cce0c7bea22fa921c2c72fb95',
  'PrestigeWW19':'0xed721dc63328be92a08b6b7d677e11100c945ea9',
  '_jamiis':'0x9e64b47bbdb9c1f7b599f11987b84c416c0c4110',
  '_etash':'0x22290f198be49fe8245cc84d11e4f4747a2000ae',
  'zzxiv':'0xc4fc783e2d06b6e86abd00e02d21fba683fb7454',
  'elirousso':'0xd8b2a9a6109049ed9b76d787deb6c9cfeb261c3e',
  'suppins':'0xc8377985c386f190e496b3a2dea70b5aa8df4eb8',
  'GmLmty':'0x92ef4baf847f2045c0a7d90ed6b3c25cc088da57',
  'sammybauch':'0x0090720fed7fed66ed658118b7b3bb0189d3a495',
  'worm_emoji':'0xfb843f8c4992efdb6b42349c35f025ca55742d33',
  'sassal0x':'0x648aa14e4424e0825a5ce739c8c68610e143fb79',
  'Stammy':'0x74bd9fe33990d1b49b196c416493186f5bb68c53',
  'mrhammn':'0xc53197e821fd28708c0d5a73e00df3167f4e6c85',
  'TheDavidZhou':'0xd61daebc28274d1feaaf51f11179cd264e4105fb',
  'mikker':'0x2c90f88be812349fdd5655c9bad8288c03e7fb23',
  'js_horne':'0x17cd072cbd45031efc21da538c783e0ed3b25dcc',
  'twobadour':'0xf8797c56d27863c81240bf7f9d158519229397d5',
  'mstultz':'0xe070daf1ac10ddab06db23b9563b8415efb7ee49',
  'AsherahEth':'0x07cbd4e4473140b6078aa987907aaff5e500b9f1',
  'BrennenHodge':'0xaf90a0d9a2573ee956a278565ee8157934f3fa9d',
  'jaesmail':'0x70ece45cdc64a768f936ccb8ac851578251363e3',
  'kaiynne':'0x42f9134e9d3bf7eee1f8a5ac2a4328b059e7468c',
  'chainyoda':'0x045038d82b5c27b5c992994cd4129aa80fd1a20c',
  'punk7642':'0x81b9a5f21efdb5df0210471b9a94e0d4ad9951ed',
  'quadzillatd':'0x9b8b24e3d406627984eb3782f358ac00431bd93a',
  'LeBoredJames':'0xf62b92c972e9cf10ae8f3297bdb870a7e6dc3ad0', 
  'LoganPaul':'0xff0bd4aa3496739d5667adc10e2b843dfab5712b', 
  'JIMMYEDGAR':'0x6a4aa35badeb1417811edb4d005384678f4da79e', 
  'jakepaul':'0xfc811061134fa6ccfd22f56cc91bf6450bea2d01', 
  'j1mmyeth':'0x442dccee68425828c106a3662014b4f131e3bd9b', 
  'gmoneyNFT':'0xf0d6999725115e3ead3d927eb3329d63afaec09b', 
  'mdudas': '0xa98220f6dc5dfca27ff19605a0a6d3e1dde4cfe8', 
  'farokh': '0xc5f59709974262c4afacc5386287820bdbc7eb3a', 
  'richerd': '0xeb1c22baacafac7836f20f684c946228401ff01c', 
  'josiahtullis': '0xdfafa55c52beee3548272e3c2678bdf5b65d33b4', 
  'scotato': '0xc6c41119af1e0840357245c66baaf0e21b694d4d', 
  'keltron_': '0x55907cf476998d2f58591c6d0a10ecbbe249a8eb', 
  'andy8052': '0x90e5aa59a9df2add394df81521dbbed5f3c4a1a3', 
  'ColeThereum': '0xfe5573c66273313034f7ff6050c54b5402553716', 
  'economist': '0xcfc9e5258a8773cea0440077779a17096a045bf2', 
  'long': '0x1bbcb5af65cd900c6b1e305e1dfb5a894177aa3c',
  '3LAU': '0xd2aff66959ee0e6f92ee02d741071ddb5084bebb',
  'garyvee': '0xd6a984153acb6c9e2d788f08c2465a1358bb89a7',
  'punk4156': '0xf476cd75be8fdd197ae0b466a2ec2ae44da41897',
  'BoredSev': '0xf6c762d6edc268e644e6629cc1e5381885ede851',
  '_jeffnicholas_': '0x8ee94e820e7e898f47ac934a755d7382d088edd4',
  'DrifterShoots': '0x9dbe56e65961146525d796bdc008225bd5915a4f',
  'jarroddicker': '0x7fdca0a469ea8b50b92322afc0215b67d56a5e9a',
  'fvckrender': '0xfDeD90A3B1348425577688866f798f94d77A0D02', 
  'SHL0MS': '0x38488dca8dccfeebfd3cc298436134e3b3af6b8b', 
  'mikedemarais': '0xe5501bc2b0df6d0d7daafc18d2ef127d9e612963', 
  'SirVincentFred': '0xef36f4d2a2f04d9284b1758518a9b8c6371accea', 
  'CapetainTrippy': '0xfc48426da0338735945badef273736ccff53a358', 
  'BoredSpaceApe': '0xa078efb1e49bd30fc720fb8f6aadc2228b15a53d', 
  'boredgentleman': '0xfe9c9591d0f1ea7464ba503bed40e06f5b62d1a1', 
  'beijingdou': '0xaf469c4a0914938e6149cf621c54fb4b1ec0c202', 
  'pranksy': '0xd387a6e4e84a6c86bd90c158c6028a58cc8ac459', 
  'treasuresETH': '0xdc8eb8d2d1babd956136b57b0b9f49b433c019e3',
  'xBenJamminx': '0xa41a4b84d74e085bd463386d55c3b6dde6aa2759', 
  'wowbestie': '0x79e087a1957fccf93649d3732f9193f0fc8c5138', 
  'TheSmarmyBum': '0x689717c0b1ab0f188235cfa487ced32feebf9698',
  'ChainLinkGod': '0x190473b3071946df65306989972706a4c006a561',
  'jackbutcher': '0xc8f8e2F59Dd95fF67c3d39109ecA2e2A017D4c8a',
  'elirousso': '0xd8b2a9a6109049ed9b76d787deb6c9cfeb261c3e',
  'VitalikButerin': '0xAb5801a7D398351b8bE11C439e05C5B3259aeC9B',
};



function fmtPrice(s) {
  const d = BigInt(Math.pow(10, 18)); // 1 Ether = 10^18 Wei
  return ((BigInt(s)/d).toString() + '.'
    + (BigInt(s)%d).toString().padStart(18, '0')).replace(/\.?0*$/, '');
}

function animate(item) {
  let duration = 1000 * item.time,
      end = +new Date() + duration;
  const step = () => {
    let current = +new Date(),
        remaining = end - current;
    if (remaining < 60) {
      item.progress(1);
    } else {
      item.progress(1 - remaining/duration);
      requestAnimationFrame(step);
    }
  };
  step();
}

async function getFeed() {
  const feed = document.evaluate(
    '//*[@id="react-root"]/div/div/div[2]/main/div/div/div/div[1]/div',
    document, null, XPathResult.FIRST_ORDERED_NODE_TYPE, null
  ).singleNodeValue;

  // remove placeholders to cleanup on reload
  const activityFeedCardPlaceholder = matchMedia('(prefers-color-scheme: dark)').matches
    ? 'activityFeedCardPlaceholder-dark'
    : 'activityFeedCardPlaceholder';
  const oldElems = document.getElementsByClassName(activityFeedCardPlaceholder);
  for (let i=oldElems.length-1; i >= 0; --i) {
    oldElems[i].remove();
  }

  // create alpha version note
  const demoContainer = document.createElement('section');
  const demoContainerId = matchMedia('(prefers-color-scheme: dark)').matches
    ? 'demoContainer-dark'
    : 'demoContainer';
  demoContainer.setAttribute("id", demoContainerId);
  demoContainer.innerHTML = 'This is a demo of the NFT activity feed.';
  feed.parentElement.append(demoContainer);

  // create progressbar
  const loadingBarContainer = document.createElement('div');
  loadingBarContainer.setAttribute('id', 'myProgress');
  loadingBarContainer.innerHTML = `<div id="myBar"></div>`;
  feed.parentElement.append(loadingBarContainer);

  // Create placeholder cards
  for (let i=0; i < 10; i++) {
    const outterDiv = document.createElement('div');
    const activityFeedCardPlaceholderClass = matchMedia('(prefers-color-scheme: dark)').matches
      ? 'activityFeedCardPlaceholder-dark'
      : 'activityFeedCardPlaceholder';
    outterDiv.classList.add(activityFeedCardPlaceholderClass);
    const innerHTML = matchMedia('(prefers-color-scheme: dark)').matches
      ? `
      <div class="activityFeedImagePlaceholder-dark"></div>
      <a class="activityFeedDatePlaceholder-dark">0 mins ago</a>
      <a class="activityEventPlaceholder-dark">Selling</a>
      <a class="activityFeedTitlePlaceholder-dark" target="_blank">Bored Ape #555</a>
      <section>
        <a href="https://twitter.com/username" class="activityFeedAuthorPlaceholder-dark">@username</a>
      </section>
    `
      : `
      <div class="activityFeedImagePlaceholder"></div>
      <a class="activityFeedDatePlaceholder">0 mins ago</a>
      <a class="activityEventPlaceholder">Selling</a>
      <a class="activityFeedTitlePlaceholder" target="_blank">Bored Ape #555</a>
      <section>
        <a href="https://twitter.com/username" class="activityFeedAuthorPlaceholder">@username</a>
      </section>
    `
    outterDiv.innerHTML = innerHTML;

    const feed = document.evaluate(
      '//*[@id="react-root"]/div/div/div[2]/main/div/div/div/div[1]/div',
      document, null, XPathResult.FIRST_ORDERED_NODE_TYPE, null
    ).singleNodeValue;
    feed.parentElement.append(outterDiv);
  }

  const delay = 115;
  animate({
    time: Object.keys(activityFeed).length * delay / 1000,
    progress: (val) => {
      const elem = document.getElementById('myBar');
      elem && (elem.style.width = (val * 100) + '%');
    }
  });
  const twoDaysAgo = (() => {
    // Get date() for Opensea fetch
    var d = new Date();
    d.setDate(d.getDate() - 1);
    let date = d.toString();
    let twoDaysAgo = new Date(date).getTime() / 1000
    // console.log(twoDaysAgo)
    return twoDaysAgo;
  })();
  let results = await Promise.all(Object.keys(activityFeed).map((name,i) => {
    return new Promise(resolve => setTimeout(resolve, i*delay)).then(() => {
      const url = `https://api.opensea.io/api/v1/events?account_address=${activityFeed[name]}&only_opensea=false&occurred_after=${twoDaysAgo}`;
      const options = {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
        }
      };
      return fetch(url, options)
        .then(res => res.json())
        .then(data => {

          return [...data.asset_events ?? []].map(event => {
            event.address = activityFeed[name];
            event.username = name;
            return event;
          });
        })
        .catch((error) => {
          if (document.getElementById('catchError') == null){
            // Removes placeholder cards
            var outterDiv = document.getElementsByClassName("activityFeedCardPlaceholder");
            if (outterDiv.length > 0) {
              for (var i = 0; i < 10; i++) {
                // console.log(outterDiv[0])
                outterDiv[0].remove();
              }
            }
            const errorTextContainer = document.createElement('div');
            const catchError = matchMedia('(prefers-color-scheme: dark)').matches
              ? 'catchError-dark'
              : 'catchError';
            errorTextContainer.setAttribute('id', catchError);
            error.innerHTML = `
              <h4>Couldn't load activity...</h4>
              <a href="https://twitter.com/nfts">Wait 30 seconds & refresh the page</a>
            `;
            feed.parentElement.append(errorTextContainer);
          }
        });
    });
  }));
  results = results.flat();
  results.sort((a,b) => { return new Date(b.created_date) - new Date(a.created_date); });

  // Removes placeholder cards
  // Removes placeholder cards
  const activityFeedCardPlaceholderClass = matchMedia('(prefers-color-scheme: dark)').matches
    ? 'activityFeedCardPlaceholder-dark'
    : 'activityFeedCardPlaceholder';
  const outterDiv = document.getElementsByClassName(activityFeedCardPlaceholderClass);
  for (let i=outterDiv.length-1; i >= 0; --i) {
    outterDiv[0].remove();
  }

  // remove loading bar
  // const loadingBarContainer = document.getElementById("myProgress")
  loadingBarContainer.remove()

  displayEvents(results);
}

function displayEvents(events) {
  if (!events) return;
  const feed = document.evaluate(
    '//*[@id="react-root"]/div/div/div[2]/main/div/div/div/div[1]/div',
    document, null, XPathResult.FIRST_ORDERED_NODE_TYPE, null
  ).singleNodeValue;
  for (const event of events) {
    // console.log(event);
    if (!event || !event.asset) continue;

    const dateTime = moment(event.created_date, 'YYYY-MM-DDTh:mm:ss')
      .utcOffset(0, true)
      .fromNow();

    const eventType = event.event_type || "Untitled"; /*  Returns "created" for new auctions, "successful" for sales, "cancelled", "bid_entered", "bid_withdrawn", "transfer", or "approve"  */
    const assetLink = event.asset.permalink;          /*  Asset link  */
    const assetName = event.asset.name
      || event.asset.collection.name + " #" + event.asset.token_id
      || event.asset.collection.name;                 /*  Asset name  */
    const assetImage = event.asset.image_url
      || event.asset.image_preview_url
      || event.asset.image_thumbnail_url
      || event.asset.collection.image_url;

    const imgSrc = event.asset.image_url.includes("mp4")
      ? event.asset.collection.image_url
      : assetImage;

    let eventTypeClass, eventTypeLabel;
    switch (eventType) {
      case 'created':
        eventTypeLabel = 'Listed',
        eventTypeClass = matchMedia('(prefers-color-scheme: dark)').matches ? 'selling-dark' : 'selling';
        break;
      case 'successful':
        if (event.seller.address === event.address) {
          eventTypeLabel = 'Sold',
          eventTypeClass = matchMedia('(prefers-color-scheme: dark)').matches ? 'sold-dark' : 'sold';
        }
        break;
      case 'transfer':
        // if (event.from_account.address === '0x0000000000000000000000000000000000000000'
        //   && event.transaction.from_account.address !== event.to_account.address)
        // {
        //    eventTypeLabel = 'Airdropped';
        //    eventTypeClass = 'purchased'
        // } else
        if (event.from_account.address !== '0x0000000000000000000000000000000000000000'
          && event.to_account.address === event.address
          && event.asset.num_sales > 0)
        {
          eventTypeLabel = 'Purchased';
          eventTypeClass = matchMedia('(prefers-color-scheme: dark)').matches ? 'purchased-dark' : 'purchased';
        }
        else if (event.transaction
          && event.transaction.from_account.address === event.to_account.address
          && event.to_account.address === event.address)
        {
          eventTypeLabel = 'Minted';
          eventTypeClass = matchMedia('(prefers-color-scheme: dark)').matches ? 'minted-dark' : 'minted';
        }
        break;
      default:
        continue;
        // break;
    }

    if (eventTypeLabel && eventTypeClass) {
      const elem = document.createElement('div');
      const activityFeedCard = matchMedia('(prefers-color-scheme: dark)').matches
        ? 'activityFeedCard-dark'
        : 'activityFeedCard';
      elem.classList.add(activityFeedCard);
      const innerHTML = matchMedia('(prefers-color-scheme: dark)').matches
        ? `
        <img src="${imgSrc}" class="activityFeedImage-dark" />
        <a class="activityFeedDate-dark">${dateTime}</a>
        <a class="${eventTypeClass}">${eventTypeLabel}</a>
        <a class="activityFeedTitle-dark" target="_blank" href="${assetLink}">${assetName}</a>
        <section>
          <a class="activityFeedAuthor-dark" href="https://twitter.com/${event.username}">@${event.username}</a>
        </section>
      `
        : `
        <img src="${imgSrc}" class="activityFeedImage" />
        <a class="activityFeedDate">${dateTime}</a>
        <a class="${eventTypeClass}">${eventTypeLabel}</a>
        <a class="activityFeedTitle" target="_blank" href="${assetLink}">${assetName}</a>
        <section>
          <a class="activityFeedAuthor" href="https://twitter.com/${event.username}">@${event.username}</a>
        </section>
      `;
      elem.innerHTML = innerHTML
      feed.parentElement.append(elem);
    }
  }
}

// ---

function parseURL(url) {
  let m = /^([^\:]+)\:\/\/([^\/]+)(\/[^\?]*)(\?.*)?$/i.exec(url);
  if (!m) return null;
  return {
    scheme: m[1],
    netloc: m[2],
    path: m[3],
    query: m[4] ? m[4].slice(1,m[4].length) : m[4]
  };
};

function insertAfter(referenceNode, newNode) {
  referenceNode.parentNode.insertBefore(newNode, referenceNode.nextSibling);
}

async function retrievAddr(name) {
  const res = await fetch('https://niftycase-twitter-ext.vercel.app/api/address', {
      method: 'POST',
      body: JSON.stringify({ name }),
      headers: {
        'Content-Type': 'application/json',
        'Access-Control-Allow-Origin': '*',
        'Access-Control-Allow-Credentials': true
      }
  });
  const user = await res.json();
  const addr = user.address;
  return addr || null;
}

async function getAddress(name) {
  console.log('search addr local');
  let addr = await AddressStore.getAddress(name);
  if (!addr || (!addr.addr || new Date(addr.created_at) < (Date.now() - 1000 * 60 * 60))) {
    // not found local or older than one hour ago
    console.log('search addr online');
    try {

      // TODO: Remove development override if more addresses are online !!!
      const _addr = await retrievAddr(name) || (function() {
        console.log('[dev] use local');
        return (addr && addr.addr) ?? null;
      })();
      // TODO: User closed account on the server.
      // !_addr && await AddressStore.delAddress(name);
      _addr && await AddressStore.setAddress(name, _addr);
      return _addr;

    } catch(err) { // prevent error message if fetch failed
      return (addr && addr.addr) ?? null;
    }
  }
  return addr.addr || null;
}

(function() {
  "use strict";

  let containerTimeout = null,
      sidebarTimeout = null,
      mainTimeout = null;

  let isMainPopulated = false;

  const fireEvent = (elem, name, props) => {
    // console.log('fire event', name, props);
    const evt = new CustomEvent(name, props ?? {});
    elem.dispatchEvent(evt);
  };

  const getCookies = () => {
    return document.cookie.split(';').reduce((res, c) => {
      const [k,v] = c.trim().split('=');
      return Object.assign(res, { [k]: v });
    }, {});
  };

  const isAuthenticated = () => {
    const cookies = getCookies();
    return 'twid' in cookies;
  }

  function populateContainer(name, addr) {
    clearTimeout(containerTimeout);
    const dest = document.querySelector('[href*="/header_photo"]');
    if (!dest) {
      containerTimeout = setTimeout(() => { populateContainer(name, addr) }, 500);
    } else {
      console.log('appending container');

      const oldElem = document.getElementById('nft-extension');
      if (oldElem && oldElem.parentElement) {
        const parent = oldElem.parentElement;
        parent.removeChild(oldElem);
      }

      const templ = matchMedia('(prefers-color-scheme: dark)').matches
        ? 'dm'
        : 'dark';

      const elem = document.createElement('iframe');
      elem.src = addr
        ? `https://mattwelter.github.io/niftycase/?addr=${addr}&view=2&templ=${templ}` // dark | dm
        : chrome.runtime.getURL('placeholder.html') + `?name=${name}`;
      elem.id = 'nft-extension';

      !addr && elem.classList.add('userDoesNotHaveNiftycase');

      dest && dest.parentElement && dest.parentElement.appendChild(elem);
    }
  }

  function populateSidebar(active) {
    if (!isAuthenticated()) {
      return;
    }
    clearTimeout(sidebarTimeout);
    let sidebarElement = document.evaluate(
      '//*[@id="react-root"]/div/div/div[2]/header/div/div/div/div[1]/div[2]/nav/a[1]',
      document,
      null,
      XPathResult.FIRST_ORDERED_NODE_TYPE,
      null
    ).singleNodeValue;
    if (!sidebarElement) {
      sidebarTimeout = setTimeout(() => { populateSidebar(active); }, 500);
    } else {
      console.log('appending to sidebar');

      var tabImgColor = function() {
        if (matchMedia('(prefers-color-scheme: dark)').matches) {
          return active ? 'https://i.imgur.com/UZq5Q0n.png' : 'https://i.imgur.com/2A61fXC.png';
        } else {
          return active ? 'https://i.imgur.com/EXHLR3g.png' : 'https://i.imgur.com/rxOs4c4.png';
        }
      }

      //   Original
      //     const imgSrc = active
      //     ? 'https://i.imgur.com/EXHLR3g.png'
      //     : 'https://i.imgur.com/rxOs4c4.png';

      //   Light mode icons
      //     https://i.imgur.com/EXHLR3g.png
      //     https://i.imgur.com/rxOs4c4.png

      //   Dark mode icons
      //     https://i.imgur.com/UZq5Q0n.png
      //     https://i.imgur.com/2A61fXC.png

      if (document.querySelector(matchMedia('(prefers-color-scheme: dark)').matches ? '.nft-tab-dark' : '.nft-tab')) {
        matchMedia('(prefers-color-scheme: dark)').matches
                  ? console.log('nft-tab-dark')
                  : console.log('nft-tab');
        const tabImg = document.getElementById('nftTabImage'),
            tabTxt = document.getElementById('nftTabText'),
            nftTab = document.querySelector(matchMedia('(prefers-color-scheme: dark)').matches ? '.nft-tab-dark' : '.nft-tab');
        tabTxt.classList.remove('bold');
        nftTab.innerHTML = `
          <div>
            <img src=${tabImgColor()} class="nftTabSvg" id="nftTabSvg" />
            <span id="nftTabText" class="${active ? 'bold' : ''}">NFTs</span>
          </div>
        `;
      } else {
        const nftTab = document.createElement('a');
        nftTab.role = 'link';
        nftTab.setAttribute('id', 'nft-tab');
        nftTab.href = '/nfts';
        const nftTabClasses = matchMedia('(prefers-color-scheme: dark)').matches
          ? 'nft-tab-dark'
          : 'nft-tab';
        nftTab.classList.add(nftTabClasses);
        nftTab.innerHTML = `
          <div>
            <img src=${tabImgColor()} class="nftTabSvg" id="nftTabSvg" />
            <span id="nftTabText" class="${active ? 'bold' : ''}">NFTs</span>
          </div>
        `;
        if (!document.getElementById("nft-tab")) {
          insertAfter(sidebarElement, nftTab);
        }
      }
    }
  }

  function populateMain(name) {
    if (!isAuthenticated() || name !== 'nfts') {
      return;
    }
    clearTimeout(mainTimeout);
    const feed = document.evaluate(
      '//*[@id="react-root"]/div/div/div[2]/main/div/div/div/div[1]/div',
      document, null, XPathResult.FIRST_ORDERED_NODE_TYPE, null
    ).singleNodeValue;
    if (!feed) {
      mainTimeout = setTimeout(() => { populateMain(name); }, 500);
    } else {
      fireEvent(window, 'DOMMainLoaded', {});
    }
  }

  chrome.runtime.onMessage.addListener(async (response, sendResponse) => {
    if (response.command === 'load') {
      const uri = parseURL(response.url);
      if (uri && uri.netloc === 'twitter.com') {
        const index =  uri.path.indexOf('/', 1);
        const name = index < 0
          ? uri.path.substring(1)
          : uri.path.substring(1, index);
        console.log('changed to', name);

        const addr = await getAddress(name);
        console.log('found:', addr, '<-', name);

        populateMain(name);
        populateContainer(name, addr);
        populateSidebar(name === 'nfts');

        window.matchMedia('(prefers-color-scheme: dark)').addEventListener(
          'change',
          function(e) {
            console.log('change theme');
            populateSidebar(name === 'nfts');
            populateContainer(name, addr);
            isMainPopulated = false;
            populateMain(name);
          }
        );
      }
    } else if (response.command === 'changed-theme') {
      console.log('theme changed');
    }
  });

  window.addEventListener('DOMMainLoaded', (event) => {
    // Change 'Profile' text to 'NFT Activity'
    if (document.evaluate('//*[@id="react-root"]/div/div/div[2]/main/div/div/div/div[1]/div[1]/div/div[1]/div/div/div/div/div[2]/div/h2/span', document, null, XPathResult.FIRST_ORDERED_NODE_TYPE, null).singleNodeValue.innerHTML = 'Profile') {
      console.log("Changed 'Profile' text to 'NFT Activity'")
      document.evaluate('//*[@id="react-root"]/div/div/div[2]/main/div/div/div/div[1]/div[1]/div/div[1]/div/div/div/div/div[2]/div/h2/span', document, null, XPathResult.FIRST_ORDERED_NODE_TYPE, null).singleNodeValue.innerHTML = 'NFT Activity'
    }

    console.log("Removed @nfts profile")
    var matchingElement = document.evaluate('//*[@id="react-root"]/div/div/div[2]/main/div/div/div/div[1]/div/div[2]/div', document, null, XPathResult.FIRST_ORDERED_NODE_TYPE, null).singleNodeValue;
    matchingElement && matchingElement.parentElement.remove(matchingElement);

    // Bug fix on profile tab
    // Profile tab redirect without the activity feed appending to profile
    var profTab = document.evaluate('//*[@id="react-root"]/div/div/div[2]/header/div/div/div/div[1]/div[2]/nav/a[7]', document, null, XPathResult.FIRST_ORDERED_NODE_TYPE, null).singleNodeValue
    var username = profTab.getAttribute("href");
    profTab.addEventListener('click', function () {
      window.location.href = `http://www.twitter.com/${username}`;
    });

    if (!isMainPopulated) {
      isMainPopulated = true;
      getFeed()
    }
  });

})();
